name: Build Flutter APK

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # ğŸ§© 1. ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ù…Ù† GitHub
      - name: Checkout repository
        uses: actions/checkout@v4

      # ğŸ› ï¸ 2. Ø¥Ø¹Ø¯Ø§Ø¯ Flutter
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'

      # ğŸ“¦ 3. ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª
      - name: Get dependencies
        run: flutter pub get

      # âš™ï¸ 4. ØªØµØ­ÙŠØ­ Ø®Ø·Ø£ flutter_local_notifications ÙÙŠ Android SDK 33
      - name: Patch flutter_local_notifications bug
        run: |
          sed -i 's/bigPictureStyle.bigLargeIcon(null);/bigPictureStyle.bigLargeIcon((android.graphics.Bitmap) null);/' $(find $HOME/.pub-cache -path "*/flutter_local_notifications*/android/src/main/java/com/dexterous/flutterlocalnotifications/FlutterLocalNotificationsPlugin.java")

      # ğŸ” 5. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¥Ù„Ù‰ embedding V2 Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±
      - name: Migrate to embedding v2
        run: flutter create .

      # ğŸ—ï¸ 6. Ø¨Ù†Ø§Ø¡ APK Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
      - name: Build release APK
        run: flutter build apk --release

      # ğŸ“¤ 7. Ø±ÙØ¹ Ø§Ù„Ù€ APK Ø§Ù„Ù†Ø§ØªØ¬ Ø¥Ù„Ù‰ GitHub Artifacts
      - name: Upload APK to artifacts
        uses: actions/upload-artifact@v4
        with:
          name: MyCalendarApp-APK
          path: build/app/outputs/flutter-apk/app-release.apk
